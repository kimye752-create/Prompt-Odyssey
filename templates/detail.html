{% extends "layout.html" %}
{% block content %}
<div class="ai-card animate-fade-in p-4 md:px-10 md:py-6 relative">
    <button id="complete-btn" class="complete-btn" onclick="toggleComplete('{{ pattern.id }}')">í•™ìŠµ ì™„ë£Œ</button>
    
    <span class="section-label">[{{ pattern.category }}] MODULE DECODED</span>
    
    <h1 class="neon-text text-2xl md:text-[2.8em] leading-tight" style="margin:10px 0;">{{ pattern.title }}</h1>
    
    <p class="theory-text text-sm md:text-base leading-relaxed">{{ pattern.content }}</p>

    <div class="injector-box p-3 md:px-6 md:py-4 mt-4">
        <div class="injector-title text-xs md:text-sm">âŒ¬ DYNAMIC VARIABLE INJECTION SYSTEM</div>
        <div id="variable-inputs" class="input-grid mt-2"></div>
        <p style="font-size: 0.8em; color: #555; margin-top: 10px; letter-spacing: 1px;">
            * ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì—¬ ì‹¤ìŠµ ì§ˆë¬¸ì„ ì™„ì„±í•˜ì„¸ìš”.
        </p>
    </div>

    <div class="terminal-body mt-4">
        <h3 class="section-label" style="font-size: 0.6rem;">LIVE_PROMPT_PREVIEW</h3>
        <pre id="prompt-content" class="text-xs md:text-sm whitespace-pre-wrap break-words">{{ pattern.example }}<span class="cursor"></span></pre>
    </div>
    
    <div class="flex flex-wrap gap-3 md:gap-4 mb-6 mt-4">
        <button class="ai-btn flex-1 md:flex-none text-sm md:text-base py-2.5 px-6" onclick="copyPrompt()">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
        <button class="ai-btn flex-1 md:flex-none text-sm md:text-base py-2.5 px-6" style="background: var(--accent-glow);" onclick="saveToLibrary()">ğŸ’¾ ì €ì¥ê³  ë³´ê´€</button>
    </div>

    <div class="library-container">
        <h3 class="library-title text-xs md:text-sm">ğŸ“ MY PROMPT LIBRARY ({{ pattern.title }})</h3>
        <div id="saved-library-list" class="saved-list"></div>
    </div>

    <div class="sandbox-container mt-6">
        <h3 class="neon-text text-lg md:text-xl" style="margin-top:0;">ğŸ§ª PROMPT SANDBOX</h3>
        <textarea id="user-input" class="sandbox-input w-full min-h-[100px] text-sm md:text-base mt-2" placeholder="ë³µì‚¬í•œ ë‚´ìš©ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”..."></textarea>
        <button class="ai-btn w-full mt-2" style="background:var(--matrix-green); color:black; font-weight: 900;" onclick="runSimulation()">SIMULATE RUN</button>
        <div id="ai-response" class="ai-response-box mt-2 p-3"><p id="response-text" class="text-sm md:text-base"></p></div>
    </div>

    <div class="quiz-box mt-6 p-6 md:px-10 md:py-6">
        <h3 class="neon-text" style="margin-top:0; font-size:1em; letter-spacing:3px;">âš¡ KNOWLEDGE CHECK</h3>
        <p class="text-sm md:text-base" style="font-weight:bold; margin:10px 0;">Q. {{ pattern.quiz.q }}</p>
        <div class="space-y-2">
            {% for opt in pattern.quiz.o %}
            <div class="quiz-option text-sm md:text-base p-3" onclick="checkQuiz('{{ loop.index0 }}', '{{ pattern.quiz.a }}')">{{ opt }}</div>
            {% endfor %}
        </div>

        <div class="mt-6 pt-4 border-t border-white/5">
            {% if next_pattern %}
                <a href="{{ url_for('detail', pattern_id=next_pattern.id) }}" 
                   class="ai-btn block w-full py-4 md:py-5 text-center bg-gradient-to-r from-cyber-cyan/20 to-cyber-purple/20 border border-cyber-cyan/30 rounded-2xl text-lg md:text-xl font-black text-cyber-cyan hover:from-cyber-cyan hover:to-cyber-purple hover:text-black transition-all shadow-[0_0_30px_rgba(0,229,255,0.2)] group">
                    ğŸš€ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™: <span class="text-white group-hover:text-black">{{ next_pattern.title }}</span>
                </a>
            {% else %}
                <a href="/" 
                   class="ai-btn block w-full py-4 md:py-5 text-center bg-white/5 border border-white/10 rounded-2xl text-lg md:text-xl font-black text-gray-400 hover:bg-white hover:text-black transition-all">
                    ğŸ  ëª¨ë“  ê¸°ì´ˆ ê³¼ì • ì™„ë£Œ! ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€
                </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
    /* [ìˆ˜ì •] IDE Problems í•´ê²° ë° 1ì›ì¹™ ìœ ì§€ */
    const originalPrompt = `{{ pattern.example | safe }}`;
    const chapterId = "{{ pattern.id }}";

    function initInjector() {
        const regex = /\{([^}]+)\}/g;
        const container = document.getElementById('variable-inputs');
        if (!container) return;
        
        let match; const variables = new Set();
        while ((match = regex.exec(originalPrompt)) !== null) { variables.add(match[1]); }
        
        if (variables.size === 0) { 
            const injector = document.querySelector('.injector-box');
            if(injector) injector.style.display = 'none'; 
            return; 
        }
        
        container.innerHTML = '';
        variables.forEach(v => {
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'var-input';
            input.placeholder = v; input.oninput = updatePrompt;
            container.appendChild(input);
        });
    }

    function updatePrompt() {
        let updated = originalPrompt;
        document.querySelectorAll('.var-input').forEach(input => {
            const val = input.value || `{${input.placeholder}}`;
            const regex = new RegExp(`\\{${input.placeholder}\\}`, 'g');
            updated = updated.replace(regex, val);
        });
        const contentEl = document.getElementById('prompt-content');
        if (contentEl) contentEl.innerHTML = updated + '<span class="cursor"></span>';
    }

    function copyPrompt() {
        const text = document.getElementById('prompt-content').innerText;
        navigator.clipboard.writeText(text).then(() => {
            if(typeof showCyberAlert === 'function') {
                showCyberAlert("ì‹œìŠ¤í…œ: í´ë¦½ë³´ë“œ ì €ì¥ì†Œì— ì§„í–‰ê³¼ì •ì´ ì ì¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            }
        });
    }

    function saveToLibrary() {
        const text = document.getElementById('prompt-content').innerText;
        const library = JSON.parse(localStorage.getItem('my_prompt_library') || '[]');
        
        const newItem = {
            id: Date.now(),
            chapter: chapterId,
            content: text,
            date: new Date().toLocaleString()
        };

        library.unshift(newItem);
        localStorage.setItem('my_prompt_library', JSON.stringify(library));
        
        if(typeof showCyberAlert === 'function') {
            showCyberAlert("SYSTEM: ë‚˜ë§Œì˜ ë¹„ê¸° ì €ì¥ì†Œì— ë³´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }
        renderLibrary();
    }

    function renderLibrary() {
        const library = JSON.parse(localStorage.getItem('my_prompt_library') || '[]');
        const container = document.getElementById('saved-library-list');
        if(!container) return;
        container.innerHTML = '';

        const myItems = library.filter(item => String(item.chapter) === String(chapterId));
        if (myItems.length === 0) {
            container.innerHTML = '<p style="color:#444; font-size:0.9em;">ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        myItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'saved-item animate-fade-in';
            div.innerHTML = `
                <div class="saved-item-header">
                    <span>ID: ${item.id}</span>
                    <span>${item.date}</span>
                </div>
                <div class="saved-content">${item.content}</div>
                <div class="action-btns">
                    <button class="mini-btn" onclick="copyText('${encodeURIComponent(item.content)}')">ë³µì‚¬</button>
                    <button class="mini-btn btn-delete" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function copyText(txt) {
        navigator.clipboard.writeText(decodeURIComponent(txt)).then(() => {
            if(typeof showCyberAlert === 'function') showCyberAlert("ë³µì‚¬ ì™„ë£Œ", "success");
        });
    }

    function deleteItem(id) {
        if(!confirm('í•´ë‹¹ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        let library = JSON.parse(localStorage.getItem('my_prompt_library') || '[]');
        library = library.filter(item => item.id !== id);
        localStorage.setItem('my_prompt_library', JSON.stringify(library));
        renderLibrary();
    }

    function runSimulation() {
        const input = document.getElementById('user-input').value;
        if(!input) {
            if(typeof showCyberAlert === 'function') showCyberAlert("ì…ë ¥ ë°ì´í„° ë¶€ì¡±", "error");
            return;
        }
        const box = document.getElementById('ai-response');
        if(box) box.style.display = 'block';
        const textEl = document.getElementById('response-text');
        if(textEl) {
            textEl.innerText = "ì•Œê³ ë¦¬ì¦˜ ì •í•©ì„± ê²€í†  ì¤‘...";
            setTimeout(() => { 
                textEl.innerText = "ê²€ì¦ ì™„ë£Œ: ìµœì ì˜ ì‘ë‹µ í’ˆì§ˆì´ ì˜ˆìƒë©ë‹ˆë‹¤."; 
            }, 1500);
        }
    }

    function checkQuiz(userIdx, correctIdx) {
        if (String(userIdx) === String(correctIdx)) {
            if(typeof showCyberAlert === 'function') {
                showCyberAlert("ì •ë‹µì…ë‹ˆë‹¤!ğŸ¯ ì˜ ì´í•´í•˜ì…¨êµ°ìš”!!", "success");
            }
            if(typeof confetti === 'function') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        } else {
            if(typeof showCyberAlert === 'function') {
                showCyberAlert("ì½”ë“œ ë¶ˆì¼ì¹˜. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”. ğŸ¤“", "error");
            }
        }
    }

    function toggleComplete(id) {
        let comp = JSON.parse(localStorage.getItem('completed_chapters') || '[]');
        const idx = comp.indexOf(parseInt(id));
        if(idx > -1) comp.splice(idx, 1); else comp.push(parseInt(id));
        localStorage.setItem('completed_chapters', JSON.stringify(comp));
        location.reload();
    }

    window.onload = () => {
        initInjector();
        renderLibrary();
        const list = JSON.parse(localStorage.getItem('completed_chapters') || '[]');
        if(list.includes(parseInt(chapterId))) {
            const btn = document.getElementById('complete-btn');
            if(btn) {
                btn.innerText = 'âœ“ COMPLETED'; 
                btn.classList.add('active');
            }
        }
    };
</script>
{% endblock %}