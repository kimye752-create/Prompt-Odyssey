{% extends "layout.html" %}

{% block content %}
<div class="fixed bottom-10 right-10 z-[100] group">
    <div class="hidden group-hover:block absolute bottom-20 right-0 w-[calc(100vw-4rem)] max-w-[20rem] md:w-80 glass-card p-8 rounded-3xl border border-[#ff00ff]/30 shadow-2xl animate-fade-in bg-black/90 backdrop-blur-xl">
        <h4 class="text-xs font-black text-[#ff00ff] mb-4 tracking-widest uppercase">Trade GPM Calculator</h4>
        <div class="space-y-4">
            <input type="number" id="sales-val" placeholder="ì˜ˆìƒ ë§¤ì¶œì•¡" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm text-white outline-none focus:border-[#ff00ff]/50">
            <input type="number" id="cost-val" placeholder="ë§¤ì¶œ ì›ê°€(ì†Œì‹±ê°€)" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm text-white outline-none focus:border-[#ff00ff]/50">
            <button onclick="calcGPM()" class="w-full py-3 bg-[#ff00ff]/20 text-[#ff00ff] font-bold rounded-xl text-xs hover:bg-[#ff00ff] hover:text-white transition-all italic uppercase tracking-widest">Run Calculation</button>
            <div id="gpm-result" class="text-center font-mono text-cyber-cyan text-lg font-black mt-2"></div>
        </div>
    </div>
    <button class="w-16 h-16 bg-[#ff00ff] text-white rounded-full shadow-[0_0_30px_#ff00ff] text-2xl font-black hover:scale-110 transition-transform flex items-center justify-center">âŒ¬</button>
</div>

<div class="animate-fade-in space-y-8 px-6 md:px-10 pt-6 pb-12">
    
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-end border-l-8 border-[#ff00ff] pl-8 pt-2 pb-0 mb-4 gap-6 lg:gap-0">
        <div>
            <h1 class="text-3xl md:text-5xl font-black tracking-tighter uppercase italic shadow-neon-white leading-tight">
                <span class="not-italic inline-block mr-3">ğŸ¤–</span> Custom  Prompt  Architect
            </h1>
            <p class="text-gray-300 mt-4 md:mt-6 text-sm md:text-base opacity-125 font-medium md:whitespace-nowrap leading-relaxed">
                ë‚´ ì—…ë¬´ì— ë§ëŠ” íŠ¹í™” AIë¥¼ ì„¤ê³„í•˜ëŠ” ê³³, Custom Prompt Architectì…ë‹ˆë‹¤. ğŸ—ï¸
            </p>
        </div>
        <div class="text-left md:text-right shrink-0">
            <span class="text-[9px] md:text-[10px] text-[#ff00ff] font-black tracking-widest block mb-1 uppercase italic">GPT-API</span>
            <span class="px-4 py-2 bg-[#ff00ff]/10 border border-[#ff00ff]/30 rounded-full text-[10px] md:text-xs font-medium text-[#ff00ff] animate-pulse">System ONLINE</span>
        </div>
    </header>

    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <button onclick="fillExample('í•´ì™¸ ë°”ì´ì–´ ë°œêµ´ ë° ì²« ê±°ë˜ ì œì•ˆ ë©”ì¼ ì‘ì„±ì„ ìœ„í•œ í“¨ìƒ·(Few-shot) í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜')" class="glass-card p-4 rounded-2xl border border-white/5 hover:border-[#ff00ff]/50 transition-all text-left group">
            <span class="text-lg block mb-1 group-hover:scale-125 transition-transform">ğŸ“§</span>
            <p class="text-[11px] md:text-[14px] font-bold text-gray-400 group-hover:text-white uppercase tracking-tighter leading-tight">B2B ì˜ì—… ì œì•ˆ</p>
        </button>
        
        <button onclick="fillExample('25ë…„ì°¨ ì „ë¬¸ ê´€ì„¸ì‚¬ì˜ ì‹œê°ìœ¼ë¡œ ì›ì‚°ì§€ ì¦ëª…ì„œ ë°œê¸‰ ì‹œ ì£¼ì˜ì‚¬í•­ì„ êµìœ¡í•˜ëŠ” í˜ë¥´ì†Œë‚˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜')" class="glass-card p-4 rounded-2xl border border-white/5 hover:border-cyber-cyan/50 transition-all text-left group">
            <span class="text-lg block mb-1 group-hover:scale-125 transition-transform">âš–ï¸</span>
            <p class="text-[11px] md:text-[14px] font-bold text-gray-400 group-hover:text-white uppercase tracking-tighter leading-tight">ê´€ì„¸/í†µê´€ ì „ë¬¸</p>
        </button>
        
        <button onclick="fillExample('í˜‘ë ¥ì‚¬ì˜ ë‹¨ê°€ ì¸ìƒ ìš”ì²­ì„ ì •ì¤‘í•˜ê³  ê²©ì‹ ìˆê²Œ ê±°ì ˆí•˜ë©° ìµœì„  í˜‘ìƒì•ˆì„ ì œì‹œí•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ í†¤ ê°€ì´ë“œ í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜')" class="glass-card p-4 rounded-2xl border border-white/5 hover:border-cyber-purple/50 transition-all text-left group">
            <span class="text-lg block mb-1 group-hover:scale-125 transition-transform">ğŸ¤</span>
            <p class="text-[11px] md:text-[14px] font-bold text-gray-400 group-hover:text-white uppercase tracking-tighter leading-tight">ì •ì¤‘í•œ ê±°ë˜ ì§„í–‰</p>
        </button>
        
        <button onclick="fillExample('ìƒí’ˆë§¤ì¶œì´ì´ìµë¥ (GPM) ë¶„ì„ì„ ìœ„í•´ ë§¤ì¶œ ë°ì´í„°ì—ì„œ í•µì‹¬ ì§€í‘œë§Œ ì¶”ì¶œí•˜ëŠ” ë¶„ì„ í”„ë ˆì„ì›Œí¬ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜')" class="glass-card p-4 rounded-2xl border border-white/5 hover:border-cyber-green/50 transition-all text-left group">
            <span class="text-lg block mb-1 group-hover:scale-125 transition-transform">ğŸ“Š</span>
            <p class="text-[11px] md:text-[14px] font-bold text-gray-400 group-hover:text-white uppercase tracking-tighter leading-tight">ë°ì´í„° ë¶„ì„</p>
        </button>
        
        <button onclick="fillExample('ë³µì¡í•˜ê³  ê¸´ ì—…ë¬´ ë¦¬í¬íŠ¸ë¥¼ ì‹¤ë¬´ìê°€ ë°”ë¡œ ì´í•´í•  ìˆ˜ ìˆê²Œ 3ì¤„ë¡œ ìš”ì•½í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜')" class="glass-card p-4 rounded-2xl border border-white/5 hover:border-yellow-500/50 transition-all text-left group col-span-2 md:col-span-1">
            <span class="text-lg block mb-1 group-hover:scale-125 transition-transform">ğŸ“</span>
            <p class="text-[11px] md:text-[14px] font-bold text-gray-400 group-hover:text-white uppercase tracking-tighter leading-tight">ì—…ë¬´ ìš”ì•½/íš¨ìœ¨</p>
        </button>
    </div>

    <div class="glass-card p-6 md:p-8 rounded-[2.5rem] border-t-2 border-t-[#ff00ff] shadow-2xl text-white">
        <h3 class="text-sm md:text-[17px] font-black tracking-[0.05em] text-[#ff00ff] mb-6 uppercase flex items-center leading-snug">
            <span class="w-2 h-2 bg-[#ff00ff] rounded-full mr-3 shadow-[0_0_10px_#ff00ff] shrink-0"></span>
            ì´ˆê°„í¸ í”„ë¡¬í”„íŠ¸ ì œì‘ ìš”ì²­: ë‹¹ì‹ ì˜ ì—…ë¬´, ëª©ì  ë° ìš°ì„  ìˆœìœ„ ë“±ì„ ê°„ë‹¨í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”.
        </h3>
        <textarea id="lab-input" class="w-full h-28 bg-white/5 border border-white/10 rounded-[1.5rem] p-6 text-sm md:text-base outline-none focus:border-[#ff00ff]/50 transition-all placeholder:text-gray-300 text-white leading-relaxed resize-none" 
                  placeholder="ë‹¹ì‹ ì˜ ì—…ë¬´ ëª©ì ê³¼ ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”. &#10; ex) í•´ì™¸ ë°”ì´ì–´ ë°œêµ´ ë° ì²« ê±°ë˜ ì œì•ˆ ë©”ì¼ ì‘ì„±ì„ ìœ„í•œ í“¨ìƒ·(Few-shot) í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜"></textarea>
        
        <button onclick="generateTactic()" id="gen-btn" class="mt-6 w-full py-4 bg-[#ff00ff]/10 border border-[#ff00ff]/40 rounded-[1.5rem] text-lg md:text-xl font-black text-[#ff00ff] hover:bg-[#ff00ff] hover:text-white transition-all hover:shadow-[0_0_40px_#ff00ff] uppercase tracking-[0.2em]">
            ë‚˜ë§Œì˜ ì‹¤ë¬´ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°
        </button>
    </div>

    <div id="result-zone" class="glass-card p-6 md:p-10 rounded-[3rem] border-t-2 border-t-cyber-cyan shadow-2xl animate-fade-in relative">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 relative z-50 gap-6 lg:gap-0">
            <h3 class="text-xs font-black tracking-[0.4em] text-cyber-cyan uppercase flex items-center">
                <span class="w-2 h-2 bg-cyber-cyan rounded-full mr-3 shadow-[0_0_10px_#00e5ff]"></span>
                í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•
            </h3>
            <div class="flex flex-wrap gap-3 md:gap-4 w-full md:w-auto">
                <button id="optimize-btn" onclick="optimizePrompt()" class="flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-cyber-cyan/20 border border-cyber-cyan/40 rounded-xl text-[11px] md:text-[13px] font-black text-cyber-cyan hover:bg-cyber-cyan hover:text-black transition-all uppercase tracking-widest italic">ğŸª„ AI ìµœì í™”</button>
                <button id="edit-mode-btn" onclick="toggleEditMode()" class="flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-rose-500/20 border border-rose-500/40 rounded-xl text-[11px] md:text-[13px] font-black text-rose-400 hover:bg-rose-500 hover:text-white transition-all uppercase tracking-widest">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
                <button onclick="copyLabResult()" class="flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-white/5 border border-white/10 rounded-xl text-[11px] md:text-[13px] font-black text-white hover:bg-white hover:text-black transition-all uppercase tracking-widest">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="saveToLabHistory()" class="flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-cyber-purple/20 border border-cyber-purple/40 rounded-xl text-[11px] md:text-[13px] font-black text-cyber-purple hover:bg-cyber-purple hover:text-white transition-all uppercase tracking-widest">ğŸ’¾ ì„œë²„ ì €ì¥</button>
                
                <div class="relative flex-1 md:flex-none">
                    <button onclick="toggleDownloadMenu(event)" class="w-full md:w-auto px-3 md:px-5 py-2 md:py-2.5 bg-cyber-cyan/20 border border-cyber-cyan/40 rounded-xl text-[11px] md:text-[13px] font-black text-cyber-cyan hover:bg-cyber-cyan hover:text-black transition-all uppercase tracking-widest">
                        Download â–¼
                    </button>
                    <div id="download-menu" class="absolute right-0 top-full pt-2 hidden z-[100]">
                        <div class="w-52 bg-[#111] border border-white/10 rounded-xl shadow-[0_20px_60px_rgba(0,0,0,0.8)] overflow-hidden backdrop-blur-3xl">
                            <button onclick="exportFile('txt')" class="w-full px-4 md:px-6 py-3 text-[10px] md:text-[12px] text-left hover:bg-white/10 transition-all font-bold border-b border-white/5 uppercase text-white">ğŸ“„ ë©”ëª¨ì¥ (.txt)</button>
                            <button onclick="exportFile('word')" class="w-full px-4 md:px-6 py-3 text-[10px] md:text-[12px] text-left hover:bg-white/10 transition-all font-bold border-b border-white/5 uppercase text-white">ğŸ“˜ ì›Œë“œ (.docx)</button>
                            <button onclick="exportFile('hwp')" class="w-full px-4 md:px-6 py-3 text-[10px] md:text-[12px] text-left hover:bg-white/10 transition-all font-bold border-b border-white/5 uppercase text-white">ğŸ“’ í•œê¸€ (.hwp)</button>
                            <button onclick="exportFile('md')" class="w-full px-4 md:px-6 py-3 text-[10px] md:text-[12px] text-left bg-cyber-cyan/5 hover:bg-cyber-cyan/20 transition-all font-black uppercase text-cyber-cyan italic font-bold">âœ¨ ë§ˆí¬ë‹¤ìš´</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="lab-result" 
             contenteditable="false" 
             spellcheck="false"
             class="relative z-0 bg-black/30 p-6 md:p-8 rounded-[1.5rem] border border-white/5 font-mono text-xs md:text-sm leading-relaxed text-gray-300 whitespace-pre-wrap border-l-4 border-l-cyber-cyan focus:outline-none transition-all shadow-inner"
             title="ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í¸ì§‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."># [ì—¬ê¸°ì— ìƒì„±í•  í”„ë¡¬í”„íŠ¸ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”]

## 1. ì—­í•  (Persona)
(ê°€ì´ë“œ: AIì—ê²Œ ë¶€ì—¬í•  ì „ë¬¸ì ì¸ ì •ì²´ì„±ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ ë˜ëŠ” ê¸°ìˆ  ì§€ì› ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤.)

## 2. ë°°ê²½ê³¼ ì˜ë„, ë§¥ë½(Context)
(ê°€ì´ë“œ: ì´ í”„ë¡¬í”„íŠ¸ê°€ í•„ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì´ë‚˜ ì˜ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì‚¬ìš©ìê°€ ë‹¬ì„±í•˜ë ¤ëŠ” ëª©ì ì´ ë¬´ì—‡ì¸ì§€ ëª…ì‹œí•©ë‹ˆë‹¤.)

## 3. ëª©í‘œ ìš°ì„ ìˆœìœ„ (Priority)
(ê°€ì´ë“œ: ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ê³ ë ¤í•´ì•¼ í•  í•µì‹¬ ê°€ì¹˜ë“¤ì„ ìˆœì„œëŒ€ë¡œ ë‚˜ì—´í•˜ì„¸ìš”.)
1. [í•µì‹¬ ëª©í‘œ]: ì˜ˆ) ìƒëŒ€ë°©ì—ê²Œ ë†’ì€ ì‹ ë¢°ê° ì£¼ê¸°
2. [í•µì‹¬ ê°€ì¹˜]: ì˜ˆ) ëª…í™•í•œ ì •ë³´ ì „ë‹¬
3. [í†¤ì•¤ë§¤ë„ˆ]: ì˜ˆ) ê²©ì‹ ìˆê³  ì „ë¬¸ì ì¸ ì–´ì¡° ìœ ì§€

## 4. ì‹¤í–‰ ì„ë¬´ (Mission)
(ê°€ì´ë“œ: AIê°€ ì‹¤ì œë¡œ ìˆ˜í–‰í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì‘ì—… ì§€ì¹¨ì„ ì…ë ¥í•˜ì„¸ìš”. ì•„ë˜ì— ê²°ê³¼ë¬¼ì˜ ì˜ˆì‹œ(Few-shot)ë¥¼ ë„£ìœ¼ë©´ ë”ìš± ì¢‹ìŠµë‹ˆë‹¤.)

### [í…œí”Œë¦¿ ì˜ˆì‹œ ì˜ì—­]
- ì—¬ê¸°ì— ì‚¬ìš©ë  ìˆ˜ ìˆëŠ” ì‹¤ì œ í…ìŠ¤íŠ¸ ìƒ˜í”Œì´ë‚˜ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.

## 5. í•µì‹¬ ì¤€ìˆ˜ ê·œì • (Compliance)
(ê°€ì´ë“œ: í’ˆì§ˆ ë³´ì¥ì„ ìœ„í•´ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì›ì¹™ì´ë‚˜ ê¸ˆê¸° ì‚¬í•­ì„ ëª…ì‹œí•˜ì„¸ìš”.)
1. **ì •í™•ì„±**: ëª¨ë“  ì •ë³´ëŠ” ì‚¬ì‹¤ì— ê¸°ë°˜í•˜ë©° ì •í™•í•´ì•¼ í•©ë‹ˆë‹¤.
2. **ë°°ë ¤**: ìƒëŒ€ë°©ì˜ ìƒí™©ê³¼ ë¬¸í™”ë¥¼ ì¡´ì¤‘í•˜ëŠ” ì–´ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. **ëª…ë£Œí•¨**: ë³µì¡í•œ ìš©ì–´ë³´ë‹¤ëŠ” ì´í•´í•˜ê¸° ì‰¬ìš´ ì–¸ì–´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</div>
    </div>

    <section class="glass-card rounded-[3rem] overflow-hidden shadow-2xl">
        <div class="px-10 py-6 border-b border-white/5 bg-white/[0.03] flex flex-col md:flex-row justify-between items-center gap-4 text-white">
            <h2 class="text-xs font-black tracking-[0.4em] uppercase flex items-center text-gray-400">
                <span class="w-3 h-3 bg-[#ff00ff] rounded-full mr-4 animate-pulse shadow-[0_0_10px_#ff00ff]"></span>
                í”„ë¡¬í”„íŠ¸ ì €ì¥ ëª©ë¡
            </h2>
            <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                <button onclick="backupAllLogs()" class="px-6 py-2.5 bg-white/5 border border-white/10 rounded-xl text-[9px] font-black hover:bg-white hover:text-black transition-all uppercase tracking-widest italic">ğŸ“š ì „ì²´ ë°±ì—… (.docx)</button>
                <span id="log-count" class="text-[10px] font-mono text-[#ff00ff] bg-[#ff00ff]/10 px-4 py-2 rounded-full font-bold uppercase">0 Logs</span>
            </div>
        </div>
        <div id="lab-history-list" class="p-8 space-y-6 max-h-[500px] overflow-y-auto custom-scrollbar text-white">
            <p class="text-center text-gray-600 py-16 italic text-sm">ì•„ì§ ì œì‘ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </section>
</div>

<script>
    function checkApiKeyAuth() {
        const savedKey = localStorage.getItem('architect_api_key');
        if(!savedKey || savedKey.trim().length < 10) {
            showCyberAlert("ğŸš¨ API Keyê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.\n AI í”„ë¡¬í”„íŒ…ì„ ìœ„í•´ ì‚¬ì´ë“œë°”ì—ì„œ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”.(SAVE)", "error");
            return false;
        }
        return savedKey;
    }

    function sanitizeForServer(text) {
        return text.replace(/\(ê°€ì´ë“œ:.*?\)/g, "").trim();
    }

    async function generateTactic() {
        const purpose = document.getElementById('lab-input').value;
        const btn = document.getElementById('gen-btn');
        const resultDiv = document.getElementById('lab-result');
        const userApiKey = checkApiKeyAuth();

        if(!purpose) return showCyberAlert("ğŸš¨ ì—…ë¬´ ìš”ì²­ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
        if(!userApiKey) return;

        if(resultDiv.innerText.includes("ê°€ì´ë“œ:")) resultDiv.innerText = "ë°ì´í„° ë¶„ì„ ë° ì„¤ê³„ ì¤‘...";

        btn.innerText = "ğŸ¤– í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘..."; btn.disabled = true; btn.classList.add('animate-pulse');
        try {
            const response = await fetch('/generate_tactic', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ purpose: purpose, api_key: userApiKey })
            });
            const data = await response.json();
            if(data.result) {
                resultDiv.innerText = data.result;
                resultDiv.scrollIntoView({ behavior: 'smooth' });
                showCyberAlert("âœ… í”„ë¡¬í”„íŒ…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } else {
                showCyberAlert(data.error || "ì‹œìŠ¤í…œ ì˜¤ë¥˜", "error");
            }
        } catch (e) { showCyberAlert("ğŸš¨ ì‹œìŠ¤í…œ ì‘ë‹µ ì—†ìŒ", "error"); }
        finally { btn.innerText = "ë‚˜ë§Œì˜ ì‹¤ë¬´ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°"; btn.disabled = false; btn.classList.remove('animate-pulse'); }
    }

    async function optimizePrompt() {
        const resultDiv = document.getElementById('lab-result');
        const currentPrompt = sanitizeForServer(resultDiv.innerText); 
        const optBtn = document.getElementById('optimize-btn');
        const userApiKey = checkApiKeyAuth();

        if(currentPrompt.length < 10) return showCyberAlert("ğŸš¨ ìµœì í™”í•  ë‚´ìš©ì´ ë„ˆë¬´ ë¶€ì¡±í•©ë‹ˆë‹¤.", "error");
        if(!userApiKey) return;

        optBtn.innerText = "âœ¨ ìµœì í™” ì¤‘..."; optBtn.disabled = true; optBtn.classList.add('animate-pulse');
        try {
            const response = await fetch('/generate_tactic', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    purpose: `[ìµœì í™” ìš”ì²­] ì•„ë˜ í”„ë¡¬í”„íŠ¸ì˜ ê³¨ìë¥¼ ìœ ì§€í•˜ë©° ë…¼ë¦¬ì  êµ¬ì¡°ì™€ í‘œí˜„ì„ ë” ì „ë¬¸ì ìœ¼ë¡œ ë‹¤ë“¬ì–´ì¤˜:\n\n${currentPrompt}`,
                    api_key: userApiKey
                })
            });
            const data = await response.json();
            if(data.result) {
                resultDiv.innerText = data.result;
                showCyberAlert("âœ¨ AIê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ë” ì •êµí•˜ê²Œ ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤.", "success");
            }
        } catch (e) { showCyberAlert("ğŸš¨ ì‹œìŠ¤í…œ ì‘ë‹µ ì—†ìŒ", "error"); }
        finally { optBtn.innerText = "ğŸª„ AI ìµœì í™”"; optBtn.disabled = false; optBtn.classList.remove('animate-pulse'); }
    }

    function calcGPM() {
        const sales = parseFloat(document.getElementById('sales-val').value);
        const cost = parseFloat(document.getElementById('cost-val').value);
        const resultDiv = document.getElementById('gpm-result');
        if (sales && cost) {
            const gpm = ((sales - cost) / sales * 100).toFixed(2);
            resultDiv.innerText = `GPM: ${gpm}%`;
            resultDiv.classList.add('animate-pulse');
            setTimeout(() => resultDiv.classList.remove('animate-pulse'), 1000);
        } else {
            showCyberAlert("ğŸ“Š ì˜ˆìƒ ë§¤ì¶œì•¡ê³¼ ì›ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "info");
        }
    }

    function toggleEditMode() {
        const resultDiv = document.getElementById('lab-result');
        const editBtn = document.getElementById('edit-mode-btn');
        if (resultDiv.contentEditable === "false") {
            resultDiv.contentEditable = "true"; resultDiv.focus();
            resultDiv.classList.add('text-white', 'border-rose-500/30');
            editBtn.innerText = "ğŸ“ ìˆ˜ì • ì¤‘...";
            editBtn.className = "flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-rose-600 border border-rose-500/40 rounded-xl text-[11px] md:text-[13px] font-black text-white transition-all uppercase tracking-widest";
        } else {
            resultDiv.contentEditable = "false";
            resultDiv.classList.remove('text-white', 'border-rose-500/30');
            editBtn.innerText = "âœï¸ ìˆ˜ì •í•˜ê¸°";
            editBtn.className = "flex-1 md:flex-none px-3 md:px-5 py-2 md:py-2.5 bg-rose-500/20 border border-rose-500/40 rounded-xl text-[11px] md:text-[13px] font-black text-rose-400 hover:bg-rose-500 hover:text-white transition-all uppercase tracking-widest";
        }
    }

    function toggleDownloadMenu(event) { event.stopPropagation(); document.getElementById('download-menu').classList.toggle('hidden'); }
    window.addEventListener('click', () => { if(document.getElementById('download-menu')) document.getElementById('download-menu').classList.add('hidden'); });
    function fillExample(text) { document.getElementById('lab-input').value = text; }
    function copyLabResult() { navigator.clipboard.writeText(document.getElementById('lab-result').innerText).then(() => showCyberAlert("ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success")); }

    async function exportFile(format) {
        const content = document.getElementById('lab-result').innerText;
        try {
            const response = await fetch('/download_doc', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content, format: format }) });
            if (response.ok) {
                const blob = await response.blob(); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob);
                a.download = `Prompt_Export_${Date.now()}.${format === 'word' ? 'docx' : format}`; a.click();
            }
        } catch (e) { showCyberAlert("ğŸš¨ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜", "error"); }
    }

    function saveToLabHistory() {
        const content = document.getElementById('lab-result').innerText;
        const purpose = document.getElementById('lab-input').value || "ì‚¬ìš©ì ì§€ì • ì„¤ê³„";
        const history = JSON.parse(localStorage.getItem('lab_history') || '[]');
        history.unshift({ id: Date.now(), purpose: purpose, content: content, date: new Date().toLocaleString() });
        localStorage.setItem('lab_history', JSON.stringify(history));
        showCyberAlert("ğŸ’¾ ê°œì¸ ë³´ê´€ì†Œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); renderLabHistory();
    }

    function renderLabHistory() {
        const history = JSON.parse(localStorage.getItem('lab_history') || '[]');
        const container = document.getElementById('lab-history-list');
        if(container) {
            document.getElementById('log-count').innerText = `${history.length} Logs`;
            container.innerHTML = history.length ? '' : '<p class="text-center text-gray-300 py-16 italic text-sm">ì•„ì§ ì œì‘ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            history.forEach(log => {
                const div = document.createElement('div');
                div.className = 'glass-card p-4 md:p-6 rounded-[1.5rem] border border-white/5 hover:border-[#ff00ff]/30 transition-all group mb-4';
                div.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h4 class="text-[11px] md:text-xs font-black text-gray-300 leading-snug">${log.purpose.substring(0, 50)}</h4></div><span class="text-[8px] font-mono text-[#ff00ff] shrink-0 ml-2">${log.date}</span></div><div class="flex gap-2"><button onclick="viewLogDetail(${log.id})" class="px-2 md:px-3 py-1 bg-white/5 rounded-lg text-[7px] md:text-[8px] font-black hover:bg-[#ff00ff] hover:text-white transition-all uppercase">ğŸ”„ Re-Load</button></div>`;
                container.appendChild(div);
            });
        }
    }

    function viewLogDetail(id) {
        const log = JSON.parse(localStorage.getItem('lab_history')).find(l => l.id === id);
        if(log) { document.getElementById('lab-result').innerText = log.content; document.getElementById('lab-input').value = log.purpose; document.getElementById('lab-result').scrollIntoView({ behavior: 'smooth' }); }
    }

    async function backupAllLogs() {
        const history = JSON.parse(localStorage.getItem('lab_history') || '[]');
        if(!history.length) return showCyberAlert("ğŸš¨ ë°±ì—…í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        try {
            const response = await fetch('/backup_all', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ logs: history }) });
            if(response.ok) {
                const blob = await response.blob(); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob);
                a.download = "My_Prompt_Bible.docx"; a.click(); showCyberAlert("ğŸ“š ì „ì²´ ë°±ì—… íŒŒì¼ ìƒì„± ì™„ë£Œ!", "success");
            }
        } catch (e) { showCyberAlert("ğŸš¨ ë°±ì—… ì„œë²„ ì˜¤ë¥˜", "error"); }
    }

    window.onload = renderLabHistory;
</script>
{% endblock %}